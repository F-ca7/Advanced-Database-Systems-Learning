## On the Production of Anorexic Plan Diagrams

<small>By Kun</small>

1. **Motivation**: 计划图(Plan Diagram)是数据库优化器在关系选择率空间内对于可执行计划的选择的可视化枚举。在过去的研究中发现，对于工业级别的数据库引擎来说，生成的计划图过于复杂和紧密，可选择的执行计划数量很多，但大部分计划占据的选择率空间很小。因此，期望对这样复杂的计划图进行一定程度的缩减，减少可执行计划的数量的同时，也不会对计划图在参数化查询优化问题中的表现产生影响。

2. **Contribution**: 

   - 计划图缩减问题是NP-Hard问题，可规约于集合覆盖问题
   - 提出了CostGreedy算法，复杂度为O(nm)，n为计划个数，m为图中的查询点个数，n<<m。该算法效率远高于AreaGreedy算法（复杂度为O(m*m)）
   - 通过实验得出不同维度下，缩减计划数随代价阈值变化的曲率凸点对应的代价阈值，以及缩减至10计划数以下的代价阈值

3. **意义**

   - 过于精确的优化方案可能会带来不必要的计算成本。考虑计划的稳定性，即变更代价接受阈值过程中，仍然稳定存在的计划。在动态选择最优计划的迭代展开过程中，基于这种计划展开
   - 在确定方案的最优边界时，通常是遍历最优计划集合中的计划，执行用户的查询方案，确定这个易错变量点上，代价最小的方案。如果预先生成的查询计划图过密，计划数量过多，会影响生成速度
   - 查询计划的密度降低时，方案的鲁棒性也有所提升：选择率估计错误的情况下，最终选择的查询计划取到最优计划的可能性仍比较大
   - 当查询参数不确定的情况下，查询计划图相比较于原来的优化器有更好的表现（原有优化器通过假定不确定参数的均值等代表性统计量来预估最优方案）。当然，这一特性需要对比所有方案在各种不同的参数输入下的表现，因此，缩减方案可以提高效率
   - 在[Plan Bouquets](https://github.com/F-ca7/Advanced-Database-Systems-Learning/blob/master/paper%20reading/robust%20query/Plan%20Bouquets.md)算法中，如果查询计划图过密，那么动态选择最优计划会对选择率的变化非常敏感，增大计算量

4. **核心方法**

   需要基于这两个基本假设：

   1. 代价随选择率递增
   2. 覆盖关系的放缩

   对于CostGreedy算法，以二维情况为例：
   1. 从右上至左下遍历查询点q，设置每个点当前所属计划cur(q)=P<sub>q</sub>，并根据代价随选择率递增原理，查找点q第一象限内的点q'，更新belong(q')=cur(q)
   2. 建立计划集合S={S<sub>1</sub>,S<sub>2</sub>,...,S<sub>n</sub>}，集合内包含可覆盖点
   3. 遍历计划集合，从最大的计划i 开始（|S<sub>i</sub>| 最大），对每个S<sub>j</sub>（S<sub>j</sub> in S)移除S<sub>i</sub>中的点，若移除后为空集，移除S<sub>j</sub>；从S中去除S<sub>i</sub>，将i加入最终剩余计划集合C中，重复该过程，直至S为空集
   4. 最终的C即为缩减结果